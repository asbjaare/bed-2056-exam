---
title: "Bed-2056 Exam"
author: "Asbjorn Aarekol & Morten Ostrem"
date: "12/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Weapons and related data worldwide
Initialy we wanted to look at if firearms ownership was related to any other usual measuring metrics for countries like GDP, life expetancy etc...

```{r create data, include=FALSE}
rm(list=ls())

# load packages
library(tidyverse)
library(rvest)
library(readxl)
library(maps)
library(ggmap)
library(mapdata)


# Read the happines data from the UN from the CSV and put it in a dataframe
# Using the data from 2017 as the wikipedia data is also from 2017
# Data gotten from kaggle
df2017 <- read_csv('2017.csv')

# Create a dataframe for all homicide worldwide and remove the source collums
# Remove the subregion rows aswell
# Data gotten from dataUNODC
homicide_df <- read_excel('homicide_all.xls') %>% 
  subset(., select = c(1:7)) %>% 
  filter(., Indicator == 'Firearms rate') %>% 
  rename("Firearm_deathrate" = Value) %>% 
  mutate("Firearm_deathrate" = as.numeric(Firearm_deathrate))

homicide_df$Territory <- replace(homicide_df$Territory, homicide_df$Territory == 'United States of America', 'USA')


# Find the table from wikipedia and return a dataframe
table <- "https://en.wikipedia.org/wiki/Estimated_number_of_civilian_guns_per_capita_by_country" %>%
  read_html() %>%
  html_nodes(xpath='//table[1]') %>% 
  html_table(header = TRUE, fill = TRUE) %>% 
  .[[1]] %>% 
  data.frame()


# Rename the variables in the wikipedia table df and merge it with the happines data
df <- table %>% 
  rename("Country" = Country..or.dependent.territory..subnational.area..etc..) %>% 
  left_join(., df2017, by = 'Country') %>% 
  rename("Happiness_score" = Happiness.Score) %>% 
  rename("GDP_percap" = Economy..GDP.per.Capita.) %>% 
  mutate("Firearms_per100" = Estimate.of.civilian.firearms.per.100.persons) %>% 
  mutate("Life_expe" = Health..Life.Expectancy.) %>% 
  mutate("Firearms_estimate" = as.numeric(gsub(",", "", Estimate.of.firearms.in.civilian.possession))) %>% 
  mutate(Population = as.numeric(gsub(",", "", Population.2017, fixed = FALSE))) %>% 
  select(Country, Firearms_per100, Population, Region, Happiness_score, GDP_percap, Life_expe) 

# Renames United states to USA
df$Country[2] = 'USA'

# Creates a map dataframe with all the data from the other df
world_map <- map_data("world") %>% 
  rename(Country = 'region')
df_map <- left_join(df, world_map, by = "Country")



homi_map <- homicide_df %>% 
  filter(., Level == "Country") %>% 
  rename("Country" = Territory) %>% 
  left_join(., world_map, by = "Country")

```

## World map of firearms rate per 100 inhabitants

```{r worldmap, echo=FALSE, fig.width = 10, fig.height = 6}

# Plots a map with the firearms 
ggplot((filter(df_map, Firearms_per100 < 1000)), aes(long, lat, group = group))+
  geom_polygon(aes(fill = Firearms_per100), color = "grey")+
  scale_fill_continuous() +
  theme_bw() +
  labs(caption = 'Blank areas are countries without data', fill = 'Firearms per 
100 inhabitants') +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.key.width = unit(1.5,"cm"))

```
Because of the outlier USA this graph gets difficult to read



## Plot of top 25 countries with highest firearms per 100 inhabitant
This plot shows the ammount of firearms per 100 inhabitants in each country.


```{r 100fire , echo=FALSE, fig.width = 10, fig.height = 8}
# TODO: Make it only top 25 or something and plot the civilian gun ownership vs the military one. 85% of firearms worldwide is owned by civilians

# Plot the countries sorted in a barplot
ggplot(filter(df, Firearms_per100 > 18.6), aes(reorder(Country, Firearms_per100), Firearms_per100, fill = Region)) +
  geom_bar(stat = "identity", show.legend = TRUE) +
  geom_text(aes(label = Firearms_per100), vjust = 1, hjust = 1, size = 3) +
  ylab('Firearms per 100 inhabitants') +
  ggtitle('Top 25 countries in the world ranked by firearms per 100 inhabitants') +
  theme_minimal() +
  theme(axis.title.y = element_blank()) +
  coord_flip()
```

## Plot of firearms per 100 inhabitants vs happines score from the World happines report
This plot is not very conclusive in any relation between the happines and ammount of firearms per 100 inhabitants

```{r fire100 vs happines, echo=FALSE, fig.width = 10, fig.height = 6}

# Plot the firearms100 vs happines
ggplot(filter(df, Firearms_per100 > 18.6), aes(Happiness_score, Firearms_per100, color = Region, size = Population)) +
  geom_jitter(aes(), show.legend = TRUE) +
  geom_text(aes(label=ifelse(Firearms_per100>34,as.character(Country),'')), hjust=0,vjust=1, size = 4, angle = 50, show.legend = FALSE)

# TODO: Fix the ugly names 
```

## Plot of GDP vs firearms 
Same as above, not much interresting to read from the data

```{r fire100 vs GDP, echo=FALSE, fig.width = 10, fig.height = 6}

# Plot the firearms100 vs GDP
ggplot(filter(df, Firearms_per100 > 18.6), aes(GDP_percap, Firearms_per100, color = Region, size = Population)) +
  geom_jitter(aes(), show.legend = TRUE) +
  geom_text(aes(label=ifelse(Firearms_per100>34,as.character(Country),'')), hjust=0,vjust=1, size = 4, angle = 50, show.legend = FALSE)

# TODO: Fix the ugly names 
```

## Life expectancy vs firearms
Same story as before

```{r fire100 vs Life expectany, echo=FALSE, fig.width = 10, fig.height = 6}

# Plot the firearms100 vs life expectancy
ggplot(filter(df, Firearms_per100 > 18.6), aes(Life_expe, Firearms_per100, color = Region, size = Population)) +
  geom_jitter(aes(), show.legend = TRUE)+
  geom_text(aes(label=ifelse(Firearms_per100>34,as.character(Country),'')), hjust=0,vjust=1, size = 4, angle = 50, show.legend = FALSE)

# TODO: Plot vs freedom value aswell
# TODO: Fix the ugly names 

```


Given these results it shows that the answer to what affects gun ownership does not corelate to any of the metrics from the happines report. 


# A Change in outlook
Given that the data did not show anything else other than that there might not be a relation between these metrics, we want to change our outlook and look at homicide by firearms.



## Homicide globaly by subregions from 2000 to 2015

```{r homicide over the years by subregion, echo=FALSE, fig.width = 10, fig.height = 6}
# TODO: Mabye split into low, medium and high. Then mabye see at if there is any data from these regions that explain what causes these differences.
ggplot(homicide_df, aes(Year, Firearm_deathrate, group = Subregion, fill = Subregion)) +
  geom_bar(stat = 'identity', show.legend = FALSE) +
  facet_wrap(~Subregion) +
  theme_light() +
  theme(axis.text.y.left = element_blank()) 


# TODO: This has way to many country names with wierd names, using this might work somehow
# https://www.kaggle.com/gbertou/iso-country-codes-with-alternative-country-names
# Use this dataset to make a crosswalk dataframe and use that df to merge the two data sets with the same country names 
ggplot(homi_map, aes(long, lat, group = group))+
  geom_polygon(aes(fill = Firearm_deathrate), color = "grey")+
  scale_fill_continuous() +
  theme_bw() +
  labs(caption = 'Blank areas are countries without data', fill = 'Homicide per 100.000 inhabitants ') +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.key.width = unit(1.5,"cm"))

```

## Firearms homicide vs firearms per 100 inhabitants
This shows that the Americas region has higher firearms per 100 inhabitants, but there does not seem to be a correlation between the firarms avaliable to people and the firearms homicide rate

```{r Firearms homicide vs firearms100, echo=FALSE, fig.width = 10, fig.height = 6}

# Create the homicide df
df_homi <- homicide_df %>% 
  # Filter out the countries, as this dataframe contains alot more
  filter(., Level == "Country") %>% 
  # 2012 seems to be the year with the most countries. Would like to get a country from the other years, but alas
  filter(., Year == 2012) %>% 
  select(Territory, Firearm_deathrate) %>% 
  mutate(Firearm_deathrate = as.numeric(Firearm_deathrate)) %>% 
  rename('Country' = Territory) %>% 
  left_join(., df, by = 'Country')


# Plot the firearms100 vs happines
ggplot(df_homi, aes(Firearms_per100, Firearm_deathrate, color = Region)) +
  geom_jitter(aes(), show.legend = TRUE) +
  ylab("Homicide rate by firearms") +
  xlab("Firearms per 100 inhabitants") +
  theme_bw()

# TODO: Look at why americas has high homicide inhabitants and and midd
# This might be moot considering that many countries are missing
```


```{r Morten sine ting tihi, echo=FALSE, fig.width = 10, fig.height = 6}

# Read the happines data from the UN from the CSV and put it in a dataframe
# Using the data from 2017 as the wikipedia data is also from 2017
# Data gotten from kaggle
df2017 <- read_csv('2017.csv')

# Create a dataframe for all homicide worldwide and remove the source collums
# Remove the subregion rows aswell
# Data gotten from dataUNODC
homicide_df <- read_excel('homicide_all.xls') %>% 
  subset(., select = c(1:7)) %>% 
  filter(., Indicator == 'Firearms rate') %>% 
  mutate("Firearms_deathrate" = as.numeric(Value))

homicide_total <- read_excel('homicide_all.xls') %>% 
  subset(., select = c(1:7)) %>% 
  filter(., Indicator == 'Homicide rate') %>% 
  mutate("Homicide_rate" = as.numeric(Value))

# Find the table from wikipedia and return a dataframe
table <- "https://en.wikipedia.org/wiki/Estimated_number_of_civilian_guns_per_capita_by_country" %>%
  read_html() %>%
  html_nodes(xpath='//table[1]') %>% 
  html_table(header = TRUE, fill = TRUE) %>% 
  .[[1]] %>% 
  data.frame()

# Rename the variables in the wikipedia table df and merge it with the happines data
table <- table %>% 
  rename("Country" = Country..or.dependent.territory..subnational.area..etc..) %>% 
  merge(., df2017) %>% 
  rename("Happiness_score" = Happiness.Score) %>% 
  rename("GDP_percap" = Economy..GDP.per.Capita.) %>% 
  mutate("Firearms_per100" = as.numeric(gsub(",", "", Estimate.of.civilian.firearms.per.100.persons))) %>% 
  mutate("Firearms_estimate" = as.numeric(gsub(",", "", Estimate.of.firearms.in.civilian.possession))) %>% 
  mutate("Reg_firearm" = as.numeric(gsub(",", "", Registered.firearms))) %>% 
  mutate("Unreg_firearm" = as.numeric(gsub(",", "", Unregistered.firearms))) %>% 
  mutate(Population = as.numeric(gsub(",", "", Population.2017, fixed = FALSE))) %>% 
  select(Country, Firearms_per100, Firearms_estimate, Reg_firearm, Unreg_firearm, Population, Region, Happiness_score, GDP_percap) 


regional_differences <- homicide_df %>% 
  filter(Year <= 2015 & Year >= 2010, Level == "Country") %>% 
  group_by(Territory) %>% 
  summarize("Firearms_deathrate" = median(Firearms_deathrate)) %>% 
  select(Territory, Firearms_deathrate) %>% 
  rename(Country = Territory) %>% 
  merge(table)

stuff <- homicide_total %>% 
  filter(Year <= 2015 & Year >= 2010, Level == "Country") %>% 
  group_by(Territory) %>% 
  summarize("Homicide_rate" = median(Homicide_rate)) %>% 
  select(Territory, Homicide_rate) %>% 
  rename(Country = Territory) %>% 
  merge(table)


more_stuff <- stuff %>% 
  merge(regional_differences) %>% 
  mutate("Ratio" = Firearms_deathrate / Homicide_rate)



#### Kind of a proof of concept if anything, looking at specific slice of happiness vs firearm homicides ####
testing <- more_stuff %>% 
  filter(Happiness_score <= 7.5 & Happiness_score >= 6.5)

ggplot(testing, aes(Happiness_score, Firearms_deathrate, color = Region, size = Population)) +
  geom_jitter(aes(),
              show.legend = TRUE) +
  xlab("Happiness score") +
  ylab("Homicide rate by firearms") +
  geom_text(data=subset(testing, Firearms_deathrate > 0.5),
            aes(label = Country, y = Firearms_deathrate - 0.5),
            size = 4,
            show.legend = FALSE)


#### Plot number of firearms(per100) vs what % of homicides committed by firearms ####
ggplot(more_stuff, aes(Firearms_per100, Ratio, color = Region, size = Population)) +
  geom_jitter(aes(),
              show.legend = TRUE) +
  xlab("Firearms per 100 inhabitants") +
  ylab("Proportion of homicides by firearm") +
  scale_y_continuous(labels = scales::percent)


#### Plot number of firearms(per100) vs total homicide rate ####
ggplot(stuff, aes(Firearms_per100, Homicide_rate, color = Region, size = Population)) +
  geom_jitter(aes(),
              show.legend = TRUE) +
  xlab("Firearms per 100 inhabitants") +
  ylab("Homicide rate") +
  theme(axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y.left = element_blank(),
        axis.text.x = element_blank()) +
  geom_text(data=subset(regional_differences, Country == "Honduras"),
            aes(label = Country, y = Firearms_deathrate - 2),
            size = 4,
            show.legend = FALSE)



#### Plot number of firearms(per100) vs homicides by firearm ####
ggplot(regional_differences, aes(Firearms_per100, Firearms_deathrate, color = Region, size = Population)) +
  geom_jitter(aes(),
              show.legend = TRUE) +
  xlab("Firearms per 100 inhabitants") +
  ylab("Homicide rate by firearms") +
  theme(axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y.left = element_blank(),
        axis.text.x = element_blank()) +
  geom_text(data=subset(regional_differences, Country == "Honduras"),
            aes(label = Country, y = Firearms_deathrate - 2),
            size = 4,
            show.legend = FALSE)


#### Plot GDP vs Happiness ####
ggplot(regional_differences, aes(GDP_percap, Happiness_score, color = Region, size = Population)) +
  geom_jitter(aes(), show.legend = TRUE) +
  xlab("GDP per capita") +
  ylab("Happiness score") +
  theme(axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y.left = element_blank(),
        axis.text.x = element_blank())


```


